deploy:
  needs: build
  runs-on: ubuntu-latest
  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create .env file
      run: echo "${{ secrets.PROD_ENV_FILE }}" > .env

    - name: Upload .env to server
      uses: appleboy/scp-action@v0.1.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        port: ${{ secrets.SERVER_PORT }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_KEY }}
        source: '.env'
        target: '/home/les/ordo_api/'

    - name: Upload docker-compose.yml to server
      uses: appleboy/scp-action@v0.1.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        port: ${{ secrets.SERVER_PORT }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_KEY }}
        source: 'docker-compose.yml'
        target: '/home/les/ordo_api/'

    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.SERVER_HOST }}
        port: ${{ secrets.SERVER_PORT }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          chmod 600 /home/les/ordo_api/.env
          export IMAGE_TAG=${{ github.sha }}
          cd /home/les/ordo_api
          docker-compose pull
          docker-compose up -d
